<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ひとこと日記 (チャット風)</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 70px; /* 入力欄の高さ分スペースを確保（下の入力欄が隠れないようにする） */
      font-family: sans-serif;
    }

    #listContainer {
      padding: 10px;
      overflow-y: auto; /* 縦スクロール可能にする */
      max-height: calc(100vh - 80px); /* 入力欄の分だけ高さを減らす */
    }

    #list li {
      white-space: pre-wrap; /* 改行や空白をそのまま表示 */
      margin-bottom: 10px; /* 各日記の間に余白 */
    }

    .entryContent {
      display: block;       /* ブロック要素化して改行を反映 */
      margin-bottom: 5px;   /* 本文と削除ボタンの間に余白 */
    }

    .deleteBtn {
      background-color: #f44336; /* 赤い削除ボタン */
      color: white;
      border: none;
      padding: 3px 6px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .deleteBtn:hover {
      background-color: #d32f2f; /* ホバー時に少し濃い赤 */
    }

    /* 入力欄を画面下に固定する */
    #inputArea {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%; /* 横幅いっぱい */
      background: #f0f0f0;
      display: flex; /* 横並び配置 */
      padding: 5px 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2); /* 上に影 */
      box-sizing: border-box;
    }

    #entry {
      flex-grow: 1;        /* 残り幅を全部使う */
      margin-right: 10px;  /* ボタンとの間隔 */
      padding: 5px;
      font-size: 1em;
    }

    #saveBtn {
      padding: 6px 12px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- 日記一覧を表示する領域 -->
  <div id="listContainer">
    <h1>ひとこと日記</h1>
    <ol id="list"></ol> <!-- データ表示用のリスト（番号付き） -->
  </div>

  <!-- 入力欄（画面下に固定表示される） -->
  <div id="inputArea">
    <textarea id="entry" rows="2" placeholder="今日のひとこと"></textarea> <!-- 入力エリア -->
    <button id="saveBtn">送信</button> <!-- 保存ボタン -->
  </div>

  <script>
    // === IndexedDB の準備 ===
    let db; // データベースオブジェクトを入れる箱
    const request = indexedDB.open("DiaryDB", 1); // 「DiaryDB」という名前でDBを開く（バージョン1）

    // 初回作成やバージョン更新時に呼ばれる
    request.onupgradeneeded = function(event) {
      db = event.target.result;
      db.createObjectStore("entries", { autoIncrement: true }); // entries というオブジェクトストアを作る
    };

    // DBが正常に開けた時
    request.onsuccess = function(event) {
      db = event.target.result;
      showEntries(); // データを画面に表示
    };

    // DBが開けなかった時のエラー処理
    request.onerror = function(event) {
      console.error("DBエラー:", event.target.error);
    };

    // === データ保存処理 ===
    document.getElementById("saveBtn").onclick = function() {
      const text = document.getElementById("entry").value; // 入力欄の文字を取得
      if (!text) return; // 何も入力されていなければ終了

      const tx = db.transaction("entries", "readwrite"); // 書き込み可能トランザクションを開始
      const store = tx.objectStore("entries"); // entries ストアを指定
      store.add({ text: text, date: new Date().toLocaleString() }); // 日付＋本文を保存

      tx.oncomplete = function() {
        document.getElementById("entry").value = ""; // 入力欄をクリア
        showEntries(); // 再表示
      };
    };

    // === データ表示処理 ===
    function showEntries() {
      const tx = db.transaction("entries", "readonly"); // 読み取り専用トランザクション
      const store = tx.objectStore("entries");
      const request = store.openCursor(); // 先頭から順にカーソルでデータを読む

      const list = document.getElementById("list");
      list.innerHTML = ""; // 一度リストを空にする

      request.onsuccess = function(event) {
        const cursor = event.target.result; // カーソル（データ1件分）
        if (cursor) {
          const li = document.createElement("li"); // リスト項目を作る

          // === 日記の内容（日時＋本文） ===
          const contentSpan = document.createElement("span");
          contentSpan.className = "entryContent";
          contentSpan.textContent = `${cursor.value.date}\n${cursor.value.text}`;

          // === 削除ボタン ===
          const delBtn = document.createElement("button");
          delBtn.textContent = "削除";
          delBtn.className = "deleteBtn";
          delBtn.dataset.key = cursor.key; // 削除に必要なキーを保持

          // 削除ボタンクリック時の処理
          delBtn.addEventListener("click", function() {
            const number = Array.from(list.children).indexOf(li) + 1; // li の番号を調べる
            if (confirm(`${number}番を削除しますか？`)) {
              deleteEntry(delBtn.dataset.key); // 削除処理へ
            }
          });

          // li に内容と削除ボタンを追加
          li.appendChild(contentSpan);
          li.appendChild(delBtn);
          list.appendChild(li);

          cursor.continue(); // 次のデータへ
        }
      };
    }

    // === 削除処理 ===
    function deleteEntry(key) {
      const tx = db.transaction("entries", "readwrite"); // 書き込み可能トランザクション
      const store = tx.objectStore("entries");
      const request = store.delete(Number(key)); // 指定したキーのデータを削除

      request.onsuccess = function() {
        showEntries(); // リストを更新
      };
    }
  </script>
</body>
</html>
