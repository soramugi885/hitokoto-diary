<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ひとこと日記 (チャット風)</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 70px; /* 入力欄の高さ分スペース確保 */
      font-family: sans-serif;
      font-size: 1.5em; /* 全体の文字を大きく */
    }

    #listContainer {
      padding: 10px;
      overflow-y: auto;
      max-height: calc(100vh - 80px); /* 入力欄の分だけ高さ調整 */
    }

    #list li {
      white-space: normal;
      margin-bottom: 10px;
    }

    .entryContent {
      display: block;
      margin-bottom: 5px;
    }

    .deleteBtn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .deleteBtn:hover {
      background-color: #d32f2f;
    }

    /* 入力欄の固定フッター */
    #inputArea {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f0f0f0;
      display: flex;
      padding: 5px 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
      box-sizing: border-box;
    }

    #entry {
      flex-grow: 1;
      margin-right: 10px;
      font-size: 1em;
      line-height: 1.5;
      min-height: 1.5em; /* 初期高さは1行分 */
      resize: none; /* ユーザーがリサイズできないように */
      overflow-y: hidden; /* スクロールバー非表示 */
      padding: 8px;
      box-sizing: border-box;
    }

    #saveBtn {
      padding: 6px 12px;
      font-size: 1em;
      cursor: pointer;
    }

    /* ページネーション */
    #pagination {
      margin-top: 10px;
    }

    #pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="listContainer">
    <h1>ひとこと日記</h1>
    <ol id="list"></ol>
    <div id="pagination">
      <button id="prevBtn">前へ</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">次へ</button>
    </div>
  </div>

  <div id="inputArea">
    <textarea id="entry" rows="1" placeholder="今日のひとこと"></textarea>
    <button id="saveBtn">保存</button>
  </div>

  <script>
    let db;
    const request = indexedDB.open("DiaryDB", 1);

    request.onupgradeneeded = function(event) {
      db = event.target.result;
      db.createObjectStore("entries", { autoIncrement: true });
    };

    request.onsuccess = function(event) {
      db = event.target.result;
      showEntries();
    };

    request.onerror = function(event) {
      console.error("DBエラー:", event.target.error);
    };

    // ページ管理
    let currentPage = 1;
    const itemsPerPage = 10;
    let allEntries = [];

    // 日記を表示
    function showEntries() {
      const tx = db.transaction("entries", "readonly");
      const store = tx.objectStore("entries");
      const request = store.getAll();

      request.onsuccess = function(event) {
        allEntries = event.target.result;
        const totalPages = Math.ceil(allEntries.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = totalPages || 1;

        const list = document.getElementById("list");
        list.innerHTML = "";

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentEntries = allEntries.slice(startIndex, endIndex);

        currentEntries.forEach((entry, index) => {
          const li = document.createElement("li");

          const dateDiv = document.createElement("div");
          dateDiv.textContent = entry.date;

          const textDiv = document.createElement("div");
          textDiv.textContent = entry.text;

          const delBtn = document.createElement("button");
          delBtn.textContent = "削除";
          delBtn.className = "deleteBtn";
          delBtn.dataset.key = index + startIndex;

          delBtn.addEventListener("click", function() {
            const number = Array.from(list.children).indexOf(li) + 1 + startIndex;
            if (confirm(`${number + 1}番を削除しますか？削除したものは復元できません！`)) {
              deleteEntry(delBtn.dataset.key);
            }
          });

          li.appendChild(dateDiv);
          li.appendChild(textDiv);
          li.appendChild(delBtn);
          list.appendChild(li);
        });

        document.getElementById("pageInfo").textContent = `ページ ${currentPage} / ${totalPages || 1}`;
      };
    }

    function deleteEntry(key) {
      const tx = db.transaction("entries", "readwrite");
      const store = tx.objectStore("entries");
      const request = store.delete(Number(key));

      request.onsuccess = function() {
        showEntries();
      };
    }

    // 新規日記追加
    document.getElementById("saveBtn").onclick = function() {
      const text = document.getElementById("entry").value;
      if (!text) return;

      const tx = db.transaction("entries", "readwrite");
      const store = tx.objectStore("entries");
      store.add({ text: text, date: new Date().toLocaleString() });

      tx.oncomplete = function() {
        document.getElementById("entry").value = "";
        document.getElementById("entry").style.height = "auto";

        // 最新ページへ移動
        const countTx = db.transaction("entries", "readonly");
        const countStore = countTx.objectStore("entries");
        const countRequest = countStore.count();

        countRequest.onsuccess = function() {
          const totalItems = countRequest.result;
          currentPage = Math.ceil(totalItems / itemsPerPage) || 1;
          showEntries();
        };
      };
    };

    // 入力欄の自動リサイズ
    const textarea = document.getElementById("entry");
    textarea.addEventListener("input", () => {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    });

    // ページ切替ボタン
    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        showEntries();
      }
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      const totalPages = Math.ceil(allEntries.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        showEntries();
      }
    });
  </script>

</body>
</html>